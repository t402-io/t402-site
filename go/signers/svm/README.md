# SVM Client Signer

Client-side Ed25519 signing for Solana-based t402 payments.

## Usage

```go
import (
    svmclient "github.com/coinbase/t402/go/mechanisms/svm/exact/client"
    svmsigners "github.com/coinbase/t402/go/signers/svm"
)

// Create signer from private key
signer, err := svmsigners.NewClientSignerFromPrivateKey("5J7W...")
if err != nil {
    log.Fatal(err)
}

// Use with ExactSvmScheme
svmScheme := svmclient.NewExactSvmScheme(signer)
```

## API

### NewClientSignerFromPrivateKey

```go
func NewClientSignerFromPrivateKey(privateKeyBase58 string) (svm.ClientSvmSigner, error)
```

Creates a client signer from a base58-encoded private key.

**Args:**
- `privateKeyBase58`: Base58-encoded Solana private key

**Returns:**
- `svm.ClientSvmSigner` implementation
- Error if key is invalid

**Examples:**

```go
// Standard format
signer, _ := svmsigners.NewClientSignerFromPrivateKey(
    "4Z7cXSyeFR8wNGMVXUE1TwtKn5D5Vu7FzEv69dokLv7KrQk7h2enu1bSz1tLTjKLuqBm1cUYXL9j3xTmD8wWEqmr",
)

// From environment variable
signer, _ := svmsigners.NewClientSignerFromPrivateKey(os.Getenv("SOLANA_PRIVATE_KEY"))

// From config file
key := loadKeyFromFile("solana-key.txt")
signer, _ := svmsigners.NewClientSignerFromPrivateKey(key)
```

## Interface Implementation

The helper implements `svm.ClientSvmSigner`:

```go
type ClientSvmSigner interface {
    Address() solana.PublicKey
    SignTransaction(ctx context.Context, tx *solana.Transaction) error
}
```

### Methods

**`Address() solana.PublicKey`**
- Returns the Solana public key (32 bytes)
- Derived from the private key

**`SignTransaction(tx *solana.Transaction) error`**
- Partially signs a Solana transaction
- Adds signature at the correct index
- Handles signature array expansion
- Used for client-side payment creation

## Supported Networks

Works with all Solana networks:

**V2 Networks (CAIP-2 format):**
- `solana:5eykt4UsFv8P8NJdTREpY1vzqKqZKvdp` - Mainnet Beta
- `solana:EtWTRABZaYq6iMfeYKouRu166VU2xqa1` - Devnet
- `solana:4uhcVJyU9pJkvQyS88uRDiswHXSCkY3z` - Testnet
- `solana:*` - Wildcard for all Solana networks

**V1 Networks (legacy):**
- `solana` - Mainnet
- `solana-devnet` - Devnet
- `solana-testnet` - Testnet

## What It Eliminates

Without this helper, users must manually implement:

1. Private key parsing from base58 (10 lines)
2. Public key derivation (3 lines)
3. Transaction message marshaling (5 lines)
4. Ed25519 signing (5 lines)
5. Account index lookup (5 lines)
6. Signature array management (15 lines)
7. Error handling (15 lines)
8. Helper functions (12 lines)

**Total: 70 lines → 1 line (98% reduction!)**

## Signing Process

### How It Works

1. **Parse Key:** Decode base58 private key
2. **Marshal Transaction:** Convert transaction to binary format
3. **Sign:** Use Ed25519 to sign message bytes
4. **Find Index:** Locate signer's public key in transaction accounts
5. **Add Signature:** Insert signature at correct position in array

### Partial Signing

Solana transactions can have multiple signers:
- Client signs first (this signer)
- Facilitator signs as fee payer (completes transaction)

```go
// Client signs (partial)
clientSigner.SignTransaction(tx) // Adds 1 signature

// Facilitator signs (completes)
facilitatorSigner.SignTransaction(tx) // Adds 2nd signature

// Now transaction is fully signed and ready to submit
```

## Security

### Private Key Format

Accepts standard Solana private key format:
- Base58-encoded string
- Typically 87-88 characters
- Generated by Solana CLI or wallets

### Signing Process

Uses industry-standard libraries:
- `github.com/gagliardetto/solana-go` for Ed25519 implementation
- Follows Solana signing specification
- Compatible with all Solana wallets and tools

### Best Practices

```go
// ✅ Good: Load from secure source
signer, _ := svmsigners.NewClientSignerFromPrivateKey(os.Getenv("SOLANA_PRIVATE_KEY"))

// ✅ Good: Load from vault/secret manager
signer, _ := svmsigners.NewClientSignerFromPrivateKey(getSecretFromVault("solana-key"))

// ❌ Bad: Hardcoded in source
signer, _ := svmsigners.NewClientSignerFromPrivateKey("4Z7cX...")
```

## Testing

Run tests:

```bash
go test github.com/coinbase/t402/go/signers/svm -v
```

Use in your own tests:

```go
import (
    "testing"
    svmsigners "github.com/coinbase/t402/go/signers/svm"
)

func TestPayment(t *testing.T) {
    // Use test private key
    testKey := "4Z7cXSyeFR8wNGMVXUE1TwtKn5D5Vu7FzEv69dokLv7KrQk7h2enu1bSz1tLTjKLuqBm1cUYXL9j3xTmD8wWEqmr"
    signer, _ := svmsigners.NewClientSignerFromPrivateKey(testKey)
    
    // Test payment flow...
}
```

## Dependencies

- `github.com/gagliardetto/solana-go` - Core Solana library
- `github.com/coinbase/t402/go/mechanisms/svm` - t402 SVM types

## Generating Test Keys

To generate a Solana private key for testing:

```bash
# Using Solana CLI
solana-keygen new --no-bip39-passphrase --outfile test-key.json
solana-keygen pubkey test-key.json

# Or in code
import solana "github.com/gagliardetto/solana-go"

privateKey := solana.NewWallet()
fmt.Println("Private Key:", privateKey.PrivateKey)
fmt.Println("Public Key:", privateKey.PublicKey())
```

## Related

- [../evm/README.md](../evm/README.md) - EVM client signer
- [../../mechanisms/svm/README.md](../../mechanisms/svm/README.md) - SVM mechanism documentation
- [../README.md](../README.md) - Signers package overview

